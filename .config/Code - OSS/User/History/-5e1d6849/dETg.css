#!/bin/bash
# Sync Hyprland decoration settings with Rofi themes

if [ ! -f ~/.cache/wal/colors.sh ]; then
    echo "Pywal colors not found!"
    exit 1
fi

source ~/.cache/wal/colors.sh

# Get Hyprland decoration settings
HYPR_CONF="$HOME/.config/hypr/hyprland.conf"

# Extract active_opacity (e.g., 0.87)
ACTIVE_OPACITY=$(grep "^\s*active_opacity" "$HYPR_CONF" | awk '{print $3}')

# Convert to hex alpha (0.87 * 255 = 221 â†’ DD in hex)
ALPHA=$(printf '%02X' $(echo "$ACTIVE_OPACITY * 255" | bc | cut -d. -f1))

# Extract rounding
ROUNDING=$(grep "^\s*rounding" "$HYPR_CONF" | awk '{print $3}')

# Get base colors - PROPERLY remove # using sed
BG=$(echo "$background" | sed 's/#//')
BG_ALT=$(echo "$color1" | sed 's/#//')
FG=$(echo "$foreground" | sed 's/#//')
SELECTED=$(echo "$color12" | sed 's/#//')
ACTIVE=$(echo "$color10" | sed 's/#//')
URGENT=$(echo "$color9" | sed 's/#//')

# Create alpha variant (8-digit hex: #RRGGBBAA)
BG_ALPHA="${BG}${ALPHA}"

echo "ðŸŽ¨ Syncing with Hyprland settings..."
echo "  Active Opacity: ${ACTIVE_OPACITY}"
echo "  Alpha Hex: ${ALPHA}"
echo "  BG (no #): ${BG}"
echo "  BG_ALPHA: ${BG_ALPHA}"
echo "  BG_ALT (no #): ${BG_ALT}"
echo "  Rounding: ${ROUNDING}px"
echo ""

# Define theme files
THEME_FILES=(
    "$HOME/.config/rofi/system-settings-v3.rasi"
    "$HOME/.config/rofi/search-app.rasi"
)

# Update each theme
for THEME_FILE in "${THEME_FILES[@]}"; do
    if [ ! -f "$THEME_FILE" ]; then
        echo "âš  Theme file not found: $THEME_FILE"
        continue
    fi
    
    # Backup
    cp "$THEME_FILE" "${THEME_FILE}.bak"
    
    # Update colors - match existing # in the file
    sed -i "/\/\*\*\*\*\*----- Global Properties/,/\*\*\*\*\*\// {
        s|background:[[:space:]]*#\+[0-9a-fA-F]*;|background:     #${BG_ALPHA};|
        s|background-alt:[[:space:]]*\+[0-9a-fA-F]*;|background-alt: ${BG_ALT};|
        s|foreground:[[:space:]]*\+[0-9a-fA-F]*;|foreground:     ${FG};|
        s|selected:[[:space:]]*\+[0-9a-fA-F]*;|selected:       ${SELECTED};|
        s|active:[[:space:]]*\+[0-9a-fA-F]*;|active:         ${ACTIVE};|
        s|urgent:[[:space:]]*\+[0-9a-fA-F]*;|urgent:         ${URGENT};|
        s|border-radius:[[:space:]]*[0-9]*px;|border-radius:  ${ROUNDING}px;|
    }" "$THEME_FILE"
    
    echo "âœ“ Updated: $(basename $THEME_FILE)"
done

echo ""
echo "âœ¨ All Rofi themes synced successfully!"
notify-send "ó°š° Rofi Sync" "Synced with Hyprland\nOpacity: ${ACTIVE_OPACITY} | Rounding: ${ROUNDING}px" -t 2000